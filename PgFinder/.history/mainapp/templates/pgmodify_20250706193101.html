{% extends 'base.html' %}
{% block title %}HOME{% endblock %}

{% block extra_css %}{% endblock extra_css %}

{% block content %}
<div class="container mt-5 mb-5">
  <div class="card shadow-lg">
    <div class="card-header bg-primary text-white">
      <h3 class="mb-0">PG Information Form</h3>
    </div>
    <div class="card-body">
      <form method="post" enctype="multipart/form-data" id="myform">
        {% csrf_token %}

        {% if errors %}
        <ul class="text-danger">
          {% for error in errors %}
          <li>{{ error }}</li>
          {% endfor %}
        </ul>
        {% endif %}

        <h5 class="mb-4">PG Information</h5>
        {% for field in form %}
        <div class="mb-3">
          <label class="form-label">{{ field.label }}</label>
          {{ field }}
          {% if field.errors %}
          <div class="text-danger small">
            {{ field.errors }}
          </div>
          {% endif %}
        </div>
        {% endfor %}

        <h5 class="mt-4 mb-3">Upload Your PG Images</h5>
        <div class="mb-3">
          <label class="form-label">Upload New Images</label>
          <input type="file" id="imageInput" name="images" class="form-control" multiple>
          <div id="imagePreview" class="mt-3"></div>
          <input type="hidden" name="deleted_images" id="deletedImages">
        </div>

        <button type="submit" class="btn btn-success mt-4">Submit</button>
      </form>
    </div>
  </div>
</div>
{% endblock content %}

{% block extra_js %}
<script>
  const input = document.getElementById('imageInput');
  const preview = document.getElementById('imagePreview');
  const deletedImageInput = document.getElementById('deletedImages');
  let selectedFiles = [];
  let deletedImageIds = [];

  // === Load already uploaded images ===
  const existingImages = [
    {% for img in images %}
      { id: {{ img.id }}, url: "{{ img.image.url }}" },
    {% endfor %}
  ];

  existingImages.forEach((img) => {
    const div = document.createElement('div');
    div.className = "image-item";
    div.setAttribute("data-existing-id", img.id);
    div.style = "display:inline-block; position:relative; margin-right:10px;";
    div.innerHTML = `
      <img src="${img.url}" width="120" style="border:1px solid #ccc; border-radius:5px;">
      <button type="button" class="remove-existing" data-id="${img.id}" style="position:absolute;top:2px;right:2px;background:red;color:white;border:none;border-radius:3px;">×</button>
    `;
    preview.appendChild(div);
  });

  // === Handle new file selection ===
  input.addEventListener('change', function () {
    selectedFiles = Array.from(this.files);
    const newPreviewOnly = document.createDocumentFragment();

    selectedFiles.forEach((file, index) => {
      const reader = new FileReader();
      reader.onload = function (e) {
        const div = document.createElement('div');
        div.className = "image-item";
        div.style = "display:inline-block; position:relative; margin-right:10px;";
        div.innerHTML = `
          <img src="${e.target.result}" width="120" style="border:1px solid #ccc; border-radius:5px;">
          <button type="button" data-index="${index}" style="position:absolute;top:2px;right:2px;background:red;color:white;border:none;border-radius:3px;">×</button>
        `;
        newPreviewOnly.appendChild(div);
      };
      reader.readAsDataURL(file);
    });

    // Keep existing image previews + add new ones
    const existingItems = Array.from(preview.querySelectorAll('.image-item[data-existing-id]'));
    preview.innerHTML = '';
    existingItems.forEach(item => preview.appendChild(item));
    preview.appendChild(newPreviewOnly);
  });

  // === Handle removing both existing & new images ===
  preview.addEventListener('click', (e) => {
    if (e.target.tagName === 'BUTTON') {
      const btn = e.target;
      const isExisting = btn.classList.contains('remove-existing');

      if (isExisting) {
        const id = btn.dataset.id;
        deletedImageIds.push(id);
        deletedImageInput.value = deletedImageIds.join(',');
        const imageDiv = btn.closest('.image-item');
        imageDiv.remove();
      } else {
        const index = parseInt(btn.getAttribute('data-index'));
        selectedFiles.splice(index, 1);

        const dataTransfer = new DataTransfer();
        selectedFiles.forEach(file => dataTransfer.items.add(file));
        input.files = dataTransfer.files;

        input.dispatchEvent(new Event('change'));
      }
    }
  });

  // === Sharing option logic ===
  const fields = document.querySelectorAll('.vacancy2, .vacancy3, .vacancy4, .vacancy, .fees2, .fees3, .fees4, .fees');
  window.onload = function () {
    fields.forEach(field => field.disabled = false);
  };

  const two_sharing = document.querySelector('.two_sharing');
  const vacancy2 = document.querySelector('.vacancy2');
  const fees2 = document.querySelector('.fees2');

  const three_sharing = document.querySelector('.three_sharing');
  const vacancy3 = document.querySelector('.vacancy3');
  const fees3 = document.querySelector('.fees3');

  const four_sharing = document.querySelector('.four_sharing');
  const vacancy4 = document.querySelector('.vacancy4');
  const fees4 = document.querySelector('.fees4');

  const other_sharing = document.querySelector('.other_sharing');
  const vacancy = document.querySelector('.vacancy');
  const fees = document.querySelector('.fees');

  const toggleFields = (checkbox, vacancyField, feeField) => {
    checkbox.addEventListener("change", () => {
      const enabled = checkbox.checked;
      [vacancyField, feeField].forEach(field => {
        field.disabled = !enabled;
        field.required = enabled;
        if (!enabled) field.value = "";
      });
    });
  };

  toggleFields(two_sharing, vacancy2, fees2);
  toggleFields(three_sharing, vacancy3, fees3);
  toggleFields(four_sharing, vacancy4, fees4);
  toggleFields(other_sharing, vacancy, fees);

  // === Sharing option validation ===
  document.getElementById('myform').addEventListener('submit', (event) => {
    if (!(two_sharing.checked || three_sharing.checked || four_sharing.checked || other_sharing.checked)) {
      event.preventDefault();
      alert("Please select at least one sharing option.");
    }
  });
</script>
{% endblock extra_js %}
